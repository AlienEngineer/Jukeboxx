(function(){var a;a=(function(){function b(d,c){this.dbClient=d;this.folders=[];this.files=[];this.currentDir="/";this.dirComponents=["Dropbox"];this.root=c;this.$root=$(this.root);this.$folderList=$("#folder-list");this.$songList=$("#music-list");this.$currentSongEntry=null;this.folderTemplate=$("#folder-template").html().trim();this.songTemplate=$("#song-template").html().trim();this.breadcrumbTemplate=$("#breadcrumb-template").html().trim();this.songStartTime=0;this.songPauseTime=0;this.songEndTime=0;this.currentSongPath=null;this.songSource=null;this.context=null;try{this.context=new AudioContext()}catch(f){try{this.context=new webkitAudioContext()}catch(f){this.showError(f,"Jukeboxx only supports modern browsers, like Mozilla Firefox, not Internet Explorer!")}}this.audioBuffers={};$("#signout-button").click((function(e){return function(g){return e.onSignOut(g)}})(this));this.setupAuthentication()}b.prototype.setupAuthentication=function(){this.dbClient.authenticate({interactive:false},(function(c){return function(e,d){if(e){return c.showError(e,"Something went wrong :(")}if(c.dbClient.isAuthenticated()){c.onAuthentication()}else{var f=$("#signin-button");f.removeClass("hidden");f.click(function(g){c.dbClient.authenticate(function(i,h){if(i){return handleError(i)}c.onAuthentication()})})}}})(this))};b.prototype.onAuthentication=function(){this.dbClient.getAccountInfo((function(c){return function(e,d){if(e){return c.showError(e,"We could not sign you in :(")}$("#app-ui").removeClass("hidden");$("#music-panel-heading").text("Songs in your Dropbox");$("#music-view").removeClass("hidden");$("#folder-view").removeClass("hidden");$("#song-progress").removeClass("hidden");$("#signin-button").addClass("hidden");$("#not-signedin").addClass("hidden");$("#signout-button").removeClass("hidden");return c.loadFolder()}})(this))};b.prototype.onSignOut=function(d,c){return this.dbClient.signOut((function(e){return function(f){if(f){return e.showError(f,"We had trouble signing you out :(")}return window.location.reload()}})(this))};b.prototype.loadFolder=function(){$("#currentDir").text("Current Directory: Dropbox"+this.currentDir);this.setComponents();this.dbClient.readdir(this.currentDir,(function(c){return function(e,d,g,h){if(e){return c.showError(e,"We could not load the current folder :(")}c.folders=[];c.files=[];for(var f=0;f<h.length;f++){if(h[f].isFolder){c.folders.push(h[f])}else{c.files.push(h[f])}}c.renderFolderView();c.renderMusicView()}})(this))};b.prototype.renderFolderView=function(){this.$folderList.empty();for(var c=0;c<this.folders.length;c++){this.$folderList.append(this.$folderEntryDom(this.folders[c]))}};b.prototype.renderMusicView=function(){this.$songList.empty();for(var c=0;c<this.files.length;c++){this.$songList.append(this.$songEntryDom(this.files[c]))}if(this.files.length==null||this.files.length==0){this.$songList.html($("#no-music").html().trim())}};b.prototype.$folderEntryDom=function(d){var c;c=$(this.folderTemplate);var e=$(".folder-name",c);e.text(d.name);e.click((function(f){return function(g){$(".folder-entry",c).addClass("active");f.changeDirectory(d.path)}})(this));return c};b.prototype.$songEntryDom=function(d){var c;c=$(this.songTemplate);$(".song-name",c).text(d.name);$(".song-play-button",c).click((function(e){return function(g){g.preventDefault();var f=$(".song-play-button",c);e.onPlay(g,d,c)}})(this));return c};b.prototype.$breadcrumbDom=function(c,e){var d;d=$(this.breadcrumbTemplate);$(".bcrumb",d).text(c);$(".bcrumb",d).click((function(f){return function(g){g.preventDefault();f.currentDir=e;f.loadFolder()}})(this));return d};b.prototype.setComponents=function(){var c=this.currentDir.split("/");c.splice(0,0,"Dropbox");this.dirComponents=[];for(var d=0;d<c.length;d++){if(c[d].length>0){this.dirComponents.push(c[d])}}var f=$("#folder-breadcrumb");f.empty();var e=[];for(var d=1;d<this.dirComponents.length;d++){e.push(this.dirComponents[d])}for(var d=0;d<this.dirComponents.length;d++){f.append(this.$breadcrumbDom(this.dirComponents[d],e.slice(0,d).join("/")))}};b.prototype.isButtonPlayState=function(d){var c=d.html().trim();return(c==='<span class="glyphicon glyphicon-play"></span>')};b.prototype.isButtonStopState=function(d){var c=d.html().trim();return(c==='<span class="glyphicon glyphicon-stop"></span>')};b.prototype.setButtonPlayState=function(c){c.html('<span class="glyphicon glyphicon-play"></span>')};b.prototype.setButtonStopState=function(c){c.html('<span class="glyphicon glyphicon-stop"></span>')};b.prototype.onPlay=function(f,e,c){var d=$(".song-play-button",c);if(this.isButtonPlayState(d)){this.stopSong();this.$currentSongEntry=c;var h=this.currentDir+"/"+e.name;this.setButtonStopState(d);if(this.audioBuffers[h]){this.setProgressBar(0,100);this.playSong(h)}else{var g=(function(i){return function(j){j.xhr.addEventListener("progress",function(k){var l=Math.floor((k.loaded/k.total)*100);if(i.$currentSongEntry===c){i.setProgressBar(0,l)}});return true}})(this);this.dbClient.onXhr.addListener(g);this.dbClient.readFile(h,{arrayBuffer:true},(function(i){return function(j,k){if(j){return i.showError(j,"We could not play this song :(")}i.addAudioBuffer(h,k,function(){if(i.$currentSongEntry===c){i.setButtonStopState(d);console.log("Loaded");i.playSong(h)}})}})(this));this.dbClient.onXhr.removeListener(g)}}else{if(this.isButtonStopState(d)){this.stopSong();this.$currentSongEntry=null;this.setButtonPlayState(d)}}};b.prototype.setProgressBar=function(c,d){$("#playback-progress").attr("style","width:"+c+"%");$("#download-progress").attr("style","width:"+(d-c)+"%")};b.prototype.addAudioBuffer=function(d,c,e){this.context.decodeAudioData(c,(function(f){return function(g){f.audioBuffers[d]=g;e()}})(this),(function(f){return function(g){f.showError(g,"We could not process this song :(")}})(this))};b.prototype.playSong=function(c,d){if(this.songSource){this.songSource.stop()}this.currentSongPath=c;this.songSource=this.context.createBufferSource();this.songSource.buffer=this.audioBuffers[c];this.songSource.loop=false;this.songSource.connect(this.context.destination);this.songSource.start(d==null?0:d);this.songStartTime=this.context.currentTime};b.prototype.stopSong=function(){if(this.songSource){this.songSource.stop()}this.setButtonPlayState($(".song-play-button",this.$currentSongEntry));this.setProgressBar(0,0)};b.prototype.changeDirectory=function(c){this.currentDir=c;this.loadFolder()};b.prototype.showError=function(c,d){$("#error-notice").removeClass("hidden");if(d){$("#error-message").text(d)}if(window.console){return console.log(c+" "+d)}};return b})();$(function(){var b;b=new Dropbox.Client({key:"8f0dxv4um4zp3l4"});return window.app=new a(b,"#app-ui")})}).call(this);